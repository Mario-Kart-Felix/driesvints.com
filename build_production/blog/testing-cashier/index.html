<!DOCTYPE html>
<html lang="en" class="bg-gray-100">

<!-- Meta -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- Site info -->
<title>Testing Cashier | Dries Vints</title>

<meta property="og:type" content="website">
<meta property="og:title" content="Testing Cashier | Dries Vints">
<meta property="og:image" content="https://driesvints.com/assets/images/driesvints.jpg">
<meta property="og:url" content="https://driesvints.com/">
<meta property="og:locale" content="en_US" />
<meta property="twitter:site" content="@driesvints">
<meta property="twitter:creator" content="@driesvints">
<meta property="twitter:url" content="https://driesvints.com/">
<meta property="twitter:title" content="Testing Cashier | Dries Vints">
<meta property="twitter:image" content="https://driesvints.com/assets/images/driesvints.jpg">

    <meta name="description" content="One of the most asked questions I get about Cashier is how you start testing your billing integration of your app. So let&#039;s check out a couple of ways how...">
    <meta property="og:description" content="One of the most asked questions I get about Cashier is how you start testing your billing integration of your app. So let&#039;s check out a couple of ways how...">
    <meta property="twitter:description" content="One of the most asked questions I get about Cashier is how you start testing your billing integration of your app. So let&#039;s check out a couple of ways how...">

    <meta property="article:published_time" content="2020-04-04" />

<link href="/blog/feed.atom" type="application/atom+xml" rel="alternate" title=" Atom Feed">

<!-- Stylsheets -->
<link href="https://fonts.googleapis.com/css?family=Muli:400,400i,600,600i,700,700i;Ubuntu+Mono" rel="stylesheet">
<link rel="stylesheet" href="/assets/build/css/main.css?id=4f8879b43f327f151f44">

<script src="https://kit.fontawesome.com/980abfb339.js"></script>


<div class="font-sans text-xl text-gray-700 leading-normal antialiased border-t-6 border-primary">
    <div class="bg-secondary text-white font-semibold hover:underline py-3 px-6" target="_blank">
        <div class="wrapper text-center">
            <a class="focus:underline focus:bg-transparent" href="https://fullstackeurope.com/2020" target="_blank" rel="noopener">
                Join me at Full Stack Europe â†’
            </a>
        </div>
    </div>

        <div id="header" class="bg-black relative text-lg">
    <div class=" bg-cover bg-no-repeat" style="background-image: url('/assets/images/header-black.jpg'); background-position: top right">
        <div class="header-image header-image-small">
            <div class="text-white py-6 pb-2 sm:pb-12">
                <div class="max-w-8xl m-auto sm:flex text-center px-6 sm:px-12">
                    <div class="sm:flex-1 text-2xl font-bold sm:text-left mb-4">
                        <a href="/" class="hover:underline">Dries Vints</a>
                    </div>
                    <div class="sm:flex-2 sm:text-right">
                        <ul class="text-2xl">
    <li class="inline-block mr-6 sm:mr-10">
        <a href="/blog">
            <i class="enlarge fas fa-rss"></i>
        </a>
    </li>
    <li class="inline-block mr-6 sm:mr-10">
        <a href="https://twitter.com/driesvints" target="_blank">
            <i class="enlarge fab fa-twitter"></i>
        </a>
    </li>
    <li class="inline-block mr-6 sm:mr-10">
        <a href="https://github.com/driesvints" target="_blank">
            <i class="enlarge fab fa-github"></i>
        </a>
    </li>
    <li class="inline-block mr-6 sm:mr-10">
        <a href="https://www.youtube.com/driesvints" target="_blank">
            <i class="enlarge fab fa-youtube"></i>
        </a>
    </li>
    <li class="inline-block">
        <a href="https://www.linkedin.com/in/driesvints" target="_blank">
            <i class="enlarge fab fa-linkedin-in"></i>
        </a>
    </li>
</ul>
                    </div>
                </div>

                <div class="content sm:max-w-lg mx-auto text-shadow-lg font-semibold px-6 mt-16 md:mr-0 xl:mr-24">
                    
                </div>
            </div>
        </div>
    </div>
    <svg class="absolute z-0 left-0 bottom-0 block w-full h-8 sm:h-24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none">
        <polygon fill="#f7fafc" points="0,100 100,0 100,100"/>
    </svg>
</div>

    <div id="content">
        <div class="py-10 sm:py-20">
            <div id="post">
                <div class="mb-12">
                    <h1 class="font-bold text-4xl mb-6">Testing Cashier</h1>
                    <p class="block text-xs uppercase text-gray-600">
                        Published on April 4, 2020
                    </p>
                </div>

                <p>One of the most asked questions I get about Cashier is how you start testing your billing integration of your app. So let's check out a couple of ways how you'd tackle that.</p>
<h2>Stripe API</h2>
<p>The best way to test Cashier and your billing integration is to actually hit the Stripe API. Doing so will give you the confidence that your billing integration is actually working as expected. In fact, <a href="https://laravel.com/docs/7.x/billing#testing">we added a section to the docs yesterday</a> that details just that.</p>
<p>To get started, add the <strong>testing</strong> version of your Stripe secret to your <code>phpunit.xml</code> file:</p>
<pre><code class="language-xml">&lt;env name="STRIPE_SECRET" value="sk_test_&lt;your-key&gt;"/&gt;</code></pre>
<p>Now, whenever you interact with Cashier while testing, it will send actual API requests to your Stripe testing environment. For convenience, you should pre-fill your Stripe testing account with subscriptions / plans that you may then use during testing.</p>
<p>Hitting the Stripe API will cause your tests to run slowly but usually you wouldn't be running these tests very often, maybe just right before you do a deploy. Therefore it's best to separate these tests into a separate directory in your test suite.</p>
<p>In order to test different kinds of scenarios in your test suite you can make use of a vast range of <a href="https://stripe.com/docs/testing">Stripe testing tokens</a>.</p>
<p>If you want to look at an example of doing these kind of tests, have a look at <a href="https://github.com/laravel/cashier/tree/10.0/tests/Integration">Cashier's own test suite</a>.</p>
<h3>stripe-mock</h3>
<p>Stripe is currently developing a library called <a href="https://github.com/stripe/stripe-mock">&quot;stripe-mock&quot;</a> which will allow to mock these expensive HTTP calls when testing. Unfortunately, the library currently is stateless and Cashier relies on persisted state in Stripe a lot. When this library eventually implements persistence, we'll update Cashier's own test suite and update these docs so you can make use of it.</p>
<h2>Hiding Behind An Interface</h2>
<p>A second option is to hide Cashier calls behind an interface. In fact, in one app I took this approach and it worked very well. The apps' tests ran very fast. Let's see how we'd tackle this.</p>
<p>We'll start off by defining an interface for our subscriptions:</p>
<pre><code class="language-php">&lt;?php

namespace App\Billing\Subscriptions;

use App\User;
use Laravel\Cashier\Subscription;

interface SubscriptionRepository
{
    public function subscribe(User $customer, string $plan, string $paymentMethod): Subscription;
}</code></pre>
<p>Then implement the actual Stripe calls which we'll use in our app:</p>
<pre><code class="language-php">&lt;?php

namespace App\Billing\Subscriptions;

use App\User;
use Laravel\Cashier\Subscription;

final class StripeSubscriptionRepository implements SubscriptionRepository
{
    public function subscribe(User $customer, string $plan, string $paymentMethod): Subscription
    {
        return $customer-&gt;newSubscription('main', $plan)-&gt;create($paymentMethod);
    }
}</code></pre>
<p>And the <code>TestSubscriptionRepository</code> which contains our testing implementation:</p>
<pre><code class="language-php">&lt;?php

namespace App\Billing\Subscriptions;

use App\User;
use Illuminate\Support\Str;
use Laravel\Cashier\Subscription;

final class TestingSubscriptionRepository implements SubscriptionRepository
{
    public function subscribe(User $customer, string $plan, string $paymentMethod): Subscription
    {
        return $customer-&gt;subscriptions()-&gt;create([
            'name' =&gt; 'main',
            'stripe_id' =&gt; Str::random(),
            'stripe_status' =&gt; 'active',
            'stripe_plan' =&gt; $plan,
            'quantity' =&gt; 1,
        ]);
    }
}</code></pre>
<p>After this you can register the implementations in the <code>register</code> method of your <code>AppServiceProvider</code>:</p>
<pre><code class="language-php">$this-&gt;app-&gt;singleton(SubscriptionRepository::class, function ($app) {
    if ($app-&gt;environment('testing')) {
        return new TestingSubscriptionRepository;
    }

    return new StripeSubscriptionRepository;
});</code></pre>
<p>And now your Stripe calls will be replaced during your tests and they'll run much faster.</p>
<p>There are a couple of downsides to this approach. First of all, you're trading part of the confidence you get when actually hitting the Stripe API. The other downside is that you'll have to partially re-implement Cashier's behavior. And depending on how much functionality you use from Cashier that could potentially be a lot. Of course, you'd only replace the parts which make Stripe calls. </p>
<h2>Mocking</h2>
<p>The third one is an obvious one when unit testing. You could use a library like <a href="https://github.com/mockery/mockery">Mockery</a> to mock those expensive API calls. Let's see how that works.</p>
<p>Imagine we have the following job:</p>
<pre><code class="language-php">&lt;?php

namespace App\Jobs;

use App\User;

final class SubscribeCustomer
{
    private User $customer;

    private string $plan;

    private string $paymentMethod;

    public function __construct(User $customer, string $plan, string $paymentMethod)
    {
        $this-&gt;customer = $customer;
        $this-&gt;plan = $plan;
        $this-&gt;paymentMethod = $paymentMethod;
    }

    public function handle(): void
    {
        $this-&gt;customer-&gt;newSubscription('main', $this-&gt;plan)
            -&gt;create($this-&gt;paymentMethod);
    }
}
</code></pre>
<p>We could write the following test where we mock the actual Cashier calls:</p>
<pre><code class="language-php">&lt;?php

namespace Tests\Unit\Jobs;

use App\User;
use App\Jobs\SubscribeCustomer;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Laravel\Cashier\SubscriptionBuilder;
use Mockery;
use PHPUnit\Framework\TestCase;

class SubscribeCustomerTest extends TestCase
{
    public function tearDown(): void
    {
        parent::tearDown();

        Mockery::close();
    }

    /** @test */
    public function it_can_process_a_new_subscription()
    {
        $subscriptionBuilder = Mockery::mock(SubscriptionBuilder::class);
        $subscriptionBuilder-&gt;shouldReceive('create')
            -&gt;with('foo-method');

        $customer = Mockery::mock(User::class);
        $customer-&gt;expects('newSubscription')
            -&gt;with('main', 'plan-1')
            -&gt;andReturn($subscriptionBuilder);

        (new SubscribeCustomer($customer, 'plan-1', 'foo-method'))-&gt;handle();
    }
}</code></pre>
<p>And thus no Stripe API calls are made. Of course this only mocks the calls but doesn't re-implements the behavior like our interface example. The above technique is ideal for unit tests but not so much for feature tests.</p>
<h2>Conclusion</h2>
<p>We've seen three different techniques when it comes to testing Cashier and while each one holds a benefit and a downside I'd still recommend making actual Stripe HTTP calls if you want to be entirely sure your billing integration works as expected. If stripe-mock ever gets persistency we can solve the speed issue that way. But definitely don't be afraid to use the other two techniques. Use what works best for your situation.</p>            </div>

            <div class="share mx-auto max-w-md mt-10 sm:mt-16 px-6 text-2xl text-center">
                <p class="text-sm italic mb-4">
                    Like what you read? Feel free to share!
                    Make sure to <a href="https://twitter.com/driesvints" target="_blank">follow me on Twitter</a> to know when my next post is out.
                </p>
                <p class="share-links mb-6">
                    <a class="text-gray-500" target="_blank"
                       href="http://twitter.com/share?text=%22Testing+Cashier%22+by+%40driesvints++-+&url=https%3A%2F%2Fdriesvints.com%2Fblog%2Ftesting-cashier">
                        <i class="enlarge fab fa-twitter"></i>
                    </a>

                    <a class="ml-4 text-gray-500" target="_blank"
                       href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fdriesvints.com%2Fblog%2Ftesting-cashier&quote=%22Testing+Cashier%22+by+Dries+Vints+-+">
                        <i class="enlarge fab fa-facebook-f"></i>
                    </a>

                    <a class="ml-4 text-gray-500" target="_blank"
                       href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fdriesvints.com%2Fblog%2Ftesting-cashier&title=%22Testing+Cashier%22+by+Dries+Vints+-+">
                        <i class="enlarge fab fa-linkedin-in"></i>
                    </a>
                </p>

                <div class="sponsors mx-auto max-w-md text-center">
    <p class="text-sm italic mb-5">
        Do you like what I do or did you ever found something that I made useful? Consider supporting me!
    </p>

    <p>
        <a class="btn text-sm mb-4" href="https://github.com/sponsors/driesvints" target="_blank">
            <i class="fab fa-github mr-1"></i> Support me regularly
        </a>

        <a class="btn text-sm mb-4" href="https://paypal.me/driesvints" target="_blank">
            <i class="fab fa-paypal mr-1"></i> Donate just once
        </a>
    </p>

    <p class="mb-4 text-sm">
        <a href="https://www.wishlistr.com/driesvints">
            Or gift something from my Wishlistr <i class="fas fa-gift"></i>
        </a>
    </p>
</div>
            </div>
        </div>

                    <div class="bg-gray-200 text-xl sm:text-2xl border-t border-gray-300 px-6">
                <div class="max-w-4xl mx-auto flex">
                    <div class="flex-1 text-center sm:text-left border-r border-gray-300 pr-6 py-10 sm:py-20">
                                                    <p class="uppercase text-sm mb-2">&leftarrow; Previous post</p>
                            <a href="/blog/blade-heroicons">Blade Heroicons</a>
                                            </div>
                    <div class="flex-1 text-center sm:text-right px-4 py-10 pl-6 sm:py-20">
                                                    <p class="uppercase text-sm mb-2">Next post &rightarrow; </p>
                            <a href="/blog/the-beauty-of-single-action-controllers">The Beauty of Single Action Controllers</a>
                                            </div>
                </div>
            </div>
        
        <div id="about" class="max-w-3xl mx-auto px-6 py-10 sm:py-20">
    <div class="text-center mb-6">
        <a href="https://twitter.com/driesvints">
            <img src="https://www.gravatar.com/avatar/e8321183acdf47a9ce838afd13a964b5?s=180" width="90" class="rounded-full enlarge inline-block mb-4 sm:mb-0 sm:mr-4" alt="">
        </a>
    </div>

    <h2 class="text-4xl text-center font-bold mb-8">About Me</h2>

    <p class="mb-4">
        I'm a software engineer from Antwerp, Belgium. I work as one of the core team members of <a href="https://laravel.com">Laravel</a>, the popular PHP framework.
    </p>

    <p class="mb-4">
        My passions are <a href="https://github.com/driesvints">open-source</a>, building communities, managing software teams, and creating quality and maintainable products.
    </p>

    <p class="mb-4">
        I'm currently building <a href="https://eventy.io">Eventy</a>, an app for user group leaders, conference organisers, speakers, attendees, sponsors and venue owners.
    </p>

    <p class="mb-4">
        Together with my buddy <a href="https://twitter.com/riasvdv">Rias</a> I organize events for <a href="https://fullstackbelgium.be">Full Stack Belgium</a> in the cities of <a href="https://meetup.com/fullstackantwerp">Antwerp</a> and <a href="https://meetup.com/fullstackghent">Ghent</a>. And together with my buddy <a href="https://twitter.com/freekmurze">Freek</a> I organise <a href="https://fullstackeurope.com">Full Stack Europe</a>, the conference for the whole team.
    </p>

    <p>
        Follow me on Twitter at <a href="https://twitter.com/driesvints" target="_blank">@driesvints</a> where I also share some <a href="https://twitter.com/i/moments/1155908429698994181">Dev Tips</a> from time to time. You can contact me by <a href="mailto:dries@vints.io">email</a>.
    </p>
</div>
    </div>
</div>

<div class="border-t border-gray-300">
    <div class="max-w-6xl mx-auto text-sm text-gray-500 sm:flex px-6 py-8">
        <div class="sm:flex-1 text-center sm:text-left mb-6 sm:mb-0 sm:mt-3">
            &copy; Dries Vints
        </div>
        <div class="sm:flex-1 text-center sm:text-right">
            <ul class="text-2xl">
    <li class="inline-block mr-6 sm:mr-10">
        <a href="/blog">
            <i class="enlarge fas fa-rss"></i>
        </a>
    </li>
    <li class="inline-block mr-6 sm:mr-10">
        <a href="https://twitter.com/driesvints" target="_blank">
            <i class="enlarge fab fa-twitter"></i>
        </a>
    </li>
    <li class="inline-block mr-6 sm:mr-10">
        <a href="https://github.com/driesvints" target="_blank">
            <i class="enlarge fab fa-github"></i>
        </a>
    </li>
    <li class="inline-block mr-6 sm:mr-10">
        <a href="https://www.youtube.com/driesvints" target="_blank">
            <i class="enlarge fab fa-youtube"></i>
        </a>
    </li>
    <li class="inline-block">
        <a href="https://www.linkedin.com/in/driesvints" target="_blank">
            <i class="enlarge fab fa-linkedin-in"></i>
        </a>
    </li>
</ul>
        </div>
    </div>
</div>

<script src="/assets/build/js/main.js?id=c627d3cd8b2c97c1bcef"></script>

<script>
        (function(f, a, t, h, o, m){
            a[h]=a[h]||function(){
                (a[h].q=a[h].q||[]).push(arguments)
            };
            o=f.createElement('script'),
                m=f.getElementsByTagName('script')[0];
            o.async=1; o.src=t; o.id='fathom-script';
            m.parentNode.insertBefore(o,m)
        })(document, window, 'https://cdn.usefathom.com/tracker.js', 'fathom');
        fathom('set', 'siteId', 'GFHEOMNZ');
        fathom('trackPageview');
    </script>
